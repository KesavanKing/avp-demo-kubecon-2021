apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/argoproj-labs/argocd-vault-plugin//manifests/cmp-sidecar?ref=cmp-sidecar

patches:
- target:
    kind: Deployment
    name: argocd-repo-server
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: argocd-repo-server
    spec:
      template:
        spec:
          containers:
            - name: avp
              env:
                - name: AVP_TYPE
                  value: vault
                - name: VAULT_ADDR
                  value: http://vault.default.svc:8200
                - name: AVP_AUTH_TYPE
                  value: k8s
                - name: AVP_K8S_ROLE
                  value: argocd
            - name: avp-helm
              env:
                - name: AVP_TYPE
                  value: vault
                - name: VAULT_ADDR
                  value: http://vault.default.svc:8200
                - name: AVP_AUTH_TYPE
                  value: k8s
                - name: AVP_K8S_ROLE
                  value: argocd
            - name: avp-kustomize
              env:
                - name: AVP_TYPE
                  value: vault
                - name: VAULT_ADDR
                  value: http://vault.default.svc:8200
                - name: AVP_AUTH_TYPE
                  value: k8s
                - name: AVP_K8S_ROLE
                  value: argocd